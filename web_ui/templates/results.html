{% extends "base.html" %}

{% block title %}Results - PeerLens{% endblock %}

{% set active_step = 4 %}

{% block content %}
<div class="page-header">
    <h1>Step 4: Synthesis Results</h1>
    <p>Your editorial briefs are ready</p>
    <div class="ai-disclaimer">
        <span class="ai-icon">ü§ñ</span>
        <p>These briefs were generated by AI (GPT-4o) based on peer review analysis. Please review for accuracy and completeness before editorial use.</p>
    </div>
</div>

<div class="results-summary">
    <h2>Summary Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_briefs }}</div>
            <div class="stat-label">Total Briefs</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.validated }}</div>
            <div class="stat-label">Validated</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ "%.0f"|format(stats.avg_confidence) }}</div>
            <div class="stat-label">Avg Confidence</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_reviews }}</div>
            <div class="stat-label">Reviews Synthesized</div>
        </div>
    </div>
</div>

<div class="export-actions">
    <h3>Export Results</h3>
    <div class="export-buttons">
        <a href="/api/export/json" class="btn btn-secondary">Download JSON</a>
        <a href="/api/export/summary" class="btn btn-secondary">Download Summary Report</a>
        <button class="btn btn-secondary" onclick="window.print()">Print View</button>
    </div>
</div>

<div class="briefs-container">
    <h2>Editorial Briefs</h2>

    {% if briefs %}
    {% for brief in briefs %}
    <div class="brief-card">
        <div class="brief-header">
            <div class="brief-title-section">
                <h3>{{ brief.manuscript_title or 'Untitled Manuscript' }}</h3>
                <div class="brief-meta">
                    <span class="manuscript-id">ID: {{ brief.manuscript_id }}</span>
                    <span class="review-count">üìä {{ brief.num_reviews_synthesized }} reviews synthesized</span>
                    <span class="validation-badge {% if brief.validation_passed %}valid{% else %}invalid{% endif %}">
                        {% if brief.validation_passed %}‚úì Validated{% else %}‚ö† Needs Review{% endif %}
                    </span>
                </div>
                <div class="ai-confidence-bar">
                    <div class="confidence-label">
                        <span class="ai-gen-label">ü§ñ AI Confidence</span>
                        <span class="confidence-value">{{ brief.confidence_score }}/100</span>
                    </div>
                    <div class="confidence-progress">
                        <div class="confidence-fill" style="width: {{ brief.confidence_score }}%; background: {% if brief.confidence_score >= 80 %}#10b981{% elif brief.confidence_score >= 60 %}#f59e0b{% else %}#ef4444{% endif %}"></div>
                    </div>
                    <p class="confidence-help">
                        {% if brief.confidence_score >= 80 %}
                            High confidence - Evidence well-supported and comprehensive
                        {% elif brief.confidence_score >= 60 %}
                            Medium confidence - Some gaps in evidence or clarity
                        {% else %}
                            Low confidence - Significant evidence gaps, manual review recommended
                        {% endif %}
                    </p>
                </div>
            </div>
            <button class="btn-expand" onclick="toggleBrief(this)">
                <span class="expand-text">Expand</span>
                <span class="collapse-text" style="display: none;">Collapse</span>
            </button>
        </div>

        <div class="brief-content" style="display: none;">
            <div class="brief-section">
                <h4>üìä Consensus Snapshot</h4>
                <div class="section-content">
                    {{ brief.consensus_summary or 'No consensus summary available' }}
                </div>
            </div>

            <div class="brief-section">
                <h4>üéØ Major Issues</h4>
                <div class="section-content">
                    {% if brief.major_issues %}
                        <div class="issues-content">{{ brief.major_issues }}</div>
                    {% else %}
                        <p class="no-content">No major issues identified</p>
                    {% endif %}
                </div>
            </div>

            <div class="brief-section">
                <h4>üìù Minor Issues</h4>
                <div class="section-content">
                    {% if brief.minor_issues %}
                        <div class="issues-content">{{ brief.minor_issues }}</div>
                    {% else %}
                        <p class="no-content">No minor issues identified</p>
                    {% endif %}
                </div>
            </div>

            <div class="brief-section">
                <h4>‚ö° Disagreements</h4>
                <div class="section-content">
                    {% if brief.disagreements %}
                        <div class="disagreements-content">{{ brief.disagreements }}</div>
                    {% else %}
                        <p class="no-content">No significant disagreements between reviewers</p>
                    {% endif %}
                </div>
            </div>

            <div class="brief-section">
                <h4>‚úçÔ∏è Author Action Checklist</h4>
                <div class="section-content">
                    {% if brief.action_checklist %}
                        <div class="actions-content">{{ brief.action_checklist }}</div>
                    {% else %}
                        <p class="no-content">No specific actions required</p>
                    {% endif %}
                </div>
            </div>

            <div class="brief-section">
                <h4>‚ùì Open Questions</h4>
                <div class="section-content">
                    {% if brief.open_questions %}
                        <div class="questions-content">{{ brief.open_questions }}</div>
                    {% else %}
                        <p class="no-content">No open questions</p>
                    {% endif %}
                </div>
            </div>

            <div class="brief-section validation-section">
                <h4>üîç AI Validation Results</h4>
                <div class="ai-process-card">
                    <div class="process-header">
                        <span class="process-icon">ü§ñ</span>
                        <div>
                            <strong>Automated Quality Validation (GPT-4o-mini)</strong>
                            <p class="process-description">AI checks for evidence coverage, consistency, and actionability</p>
                        </div>
                    </div>
                    <div class="validation-details">
                        <div class="validation-item">
                            <strong>Status:</strong>
                            <span class="{% if brief.validation_passed %}text-success{% else %}text-warning{% endif %}">
                                {% if brief.validation_passed %}‚úì Passed Quality Checks{% else %}‚ö† Manual Review Required{% endif %}
                            </span>
                        </div>
                        <div class="validation-item">
                            <strong>Confidence Level:</strong>
                            <span class="confidence-badge" style="background: {% if brief.confidence_score >= 80 %}#d1fae5{% elif brief.confidence_score >= 60 %}#fef3c7{% else %}#fee2e2{% endif %}; color: {% if brief.confidence_score >= 80 %}#065f46{% elif brief.confidence_score >= 60 %}#92400e{% else %}#991b1b{% endif %}; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                {{ brief.confidence_score }}/100
                            </span>
                        </div>
                        {% if brief.validation_notes %}
                        <div class="validation-item">
                            <strong>AI Assessment:</strong> {{ brief.validation_notes }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üìÑ</div>
        <h3>No Results Yet</h3>
        <p>Run the synthesis pipeline to generate editorial briefs</p>
        <a href="/data-selection" class="btn btn-primary">Start New Synthesis</a>
    </div>
    {% endif %}
</div>

<div class="navigation-buttons">
    <a href="/pipeline-config" class="btn btn-secondary">‚Üê Adjust Configuration</a>
    <div style="display: flex; gap: 12px;">
        <a href="/data-selection" class="btn btn-secondary">Process Another Dataset</a>
        <a href="/" class="btn btn-secondary">Back to Home</a>
    </div>
</div>

<style>
/* Formatted list styling */
.formatted-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.formatted-list li {
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 6px;
    border-left: 4px solid;
    line-height: 1.6;
    transition: all 0.2s;
}

.formatted-list li:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Positive items - green */
.positive-item {
    background: #f0fdf4;
    border-left-color: #10b981;
    color: #064e3b;
}

.positive-item::before {
    content: '‚úì';
    color: #10b981;
    font-weight: bold;
    margin-right: 8px;
}

/* Negative items - red */
.negative-item {
    background: #fef2f2;
    border-left-color: #ef4444;
    color: #7f1d1d;
}

.negative-item::before {
    content: '‚ö†';
    color: #ef4444;
    font-weight: bold;
    margin-right: 8px;
}

/* Neutral items - gray */
.neutral-item {
    background: #f8fafc;
    border-left-color: #64748b;
    color: #1e293b;
}

.neutral-item::before {
    content: '‚Ä¢';
    color: #64748b;
    font-weight: bold;
    margin-right: 8px;
}

/* Consensus sentiment styling */
.consensus-positive {
    background: #f0fdf4;
    border-left: 4px solid #10b981;
    padding: 16px;
    border-radius: 6px;
}

.consensus-negative {
    background: #fef2f2;
    border-left: 4px solid #ef4444;
    padding: 16px;
    border-radius: 6px;
}

.consensus-neutral {
    background: #f8fafc;
    border-left: 4px solid #64748b;
    padding: 16px;
    border-radius: 6px;
}

/* Override default section-content styling when using formatted lists */
.section-content:has(.formatted-list) {
    background: transparent;
    padding: 0;
}

/* AI Product UX Patterns */
.ai-disclaimer {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border: 2px solid #667eea;
    border-radius: 12px;
    padding: 16px 20px;
    margin-top: 20px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.ai-disclaimer .ai-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.ai-disclaimer p {
    margin: 0;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
}

.ai-confidence-bar {
    margin-top: 16px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
}

.confidence-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ai-gen-label {
    font-size: 13px;
    font-weight: 600;
    color: #667eea;
}

.confidence-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
}

.confidence-progress {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.confidence-help {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
    font-style: italic;
}

.ai-process-card {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
}

.process-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
}

.process-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.process-header strong {
    display: block;
    color: var(--text-primary);
    font-size: 14px;
    margin-bottom: 4px;
}

.process-description {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.5;
}

.validation-details {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.validation-item {
    font-size: 14px;
    line-height: 1.6;
}

.validation-item strong {
    color: var(--text-primary);
    margin-right: 6px;
}

.confidence-badge {
    display: inline-block;
    font-size: 13px;
}
</style>

<script>
function toggleBrief(button) {
    const card = button.closest('.brief-card');
    const content = card.querySelector('.brief-content');
    const expandText = button.querySelector('.expand-text');
    const collapseText = button.querySelector('.collapse-text');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        expandText.style.display = 'none';
        collapseText.style.display = 'inline';
        card.classList.add('expanded');
    } else {
        content.style.display = 'none';
        expandText.style.display = 'inline';
        collapseText.style.display = 'none';
        card.classList.remove('expanded');
    }
}

// Format content into structured bullets with color coding
function formatContent(text, type = 'default') {
    if (!text || text === 'Not found' || text.includes('No ') || text.includes('None')) {
        return '<p class="no-content">' + text + '</p>';
    }

    // Split by common delimiters (numbered lists, line breaks, etc.)
    let items = [];

    // Try to split by numbered lists first (1., 2., etc.)
    if (text.match(/\d+\.\s/)) {
        items = text.split(/\d+\.\s+/).filter(item => item.trim().length > 0);
    }
    // Try bullet points or dashes
    else if (text.match(/^[-‚Ä¢*]\s/m)) {
        items = text.split(/\n[-‚Ä¢*]\s+/).filter(item => item.trim().length > 0);
    }
    // Split by sentences if no clear structure
    else if (text.includes('.')) {
        items = text.split(/(?<=[.!?])\s+(?=[A-Z])/).filter(item => item.trim().length > 10);
    }
    // Last resort: split by line breaks
    else {
        items = text.split('\n').filter(item => item.trim().length > 0);
    }

    // Clean and classify each item
    let html = '<ul class="formatted-list">';
    items.forEach(item => {
        item = item.trim();
        if (item.length === 0) return;

        const sentiment = classifyItem(item, type);
        const cssClass = sentiment === 'positive' ? 'positive-item' :
                        sentiment === 'negative' ? 'negative-item' :
                        'neutral-item';

        html += `<li class="${cssClass}">${item}</li>`;
    });
    html += '</ul>';

    return html;
}

function classifyItem(text, type) {
    const textLower = text.toLowerCase();

    // Positive indicators
    const positiveWords = [
        'strength', 'well-done', 'excellent', 'good', 'clear', 'comprehensive',
        'thorough', 'rigorous', 'appropriate', 'adequate', 'sound', 'robust',
        'convincing', 'valid', 'correct', 'impressive', 'innovative', 'novel',
        'well-written', 'well-designed', 'successful', 'agree', 'support'
    ];

    // Negative indicators
    const negativeWords = [
        'issue', 'problem', 'concern', 'weakness', 'lacking', 'insufficient',
        'unclear', 'confusing', 'incomplete', 'missing', 'error', 'mistake',
        'flaw', 'limitation', 'inadequate', 'questionable', 'problematic',
        'failed', 'incorrect', 'inconsistent', 'contradictory', 'concern',
        'disagree', 'reject', 'needs', 'should', 'must', 'require', 'improve'
    ];

    // Count positive and negative words
    let positiveCount = 0;
    let negativeCount = 0;

    positiveWords.forEach(word => {
        if (textLower.includes(word)) positiveCount++;
    });

    negativeWords.forEach(word => {
        if (textLower.includes(word)) negativeCount++;
    });

    // For major/minor issues, default to negative unless clearly positive
    if (type === 'issues') {
        return negativeCount > positiveCount ? 'negative' : 'neutral';
    }

    // For consensus, look for balance
    if (type === 'consensus') {
        if (positiveCount > negativeCount) return 'positive';
        if (negativeCount > positiveCount) return 'negative';
        return 'neutral';
    }

    // Default classification
    if (positiveCount > negativeCount + 1) return 'positive';
    if (negativeCount > positiveCount + 1) return 'negative';
    return 'neutral';
}

// Apply formatting to all content sections on load
window.addEventListener('load', function() {
    // Format all issues sections
    document.querySelectorAll('.issues-content').forEach(el => {
        el.innerHTML = formatContent(el.textContent, 'issues');
    });

    // Format disagreements
    document.querySelectorAll('.disagreements-content').forEach(el => {
        el.innerHTML = formatContent(el.textContent, 'issues');
    });

    // Format action checklists
    document.querySelectorAll('.actions-content').forEach(el => {
        el.innerHTML = formatContent(el.textContent, 'default');
    });

    // Format open questions
    document.querySelectorAll('.questions-content').forEach(el => {
        el.innerHTML = formatContent(el.textContent, 'default');
    });

    // Format consensus (keep as paragraph but add sentiment class)
    document.querySelectorAll('.brief-section:first-child .section-content').forEach(el => {
        const text = el.textContent.trim();
        const sentiment = classifyItem(text, 'consensus');
        el.className = `section-content consensus-${sentiment}`;
    });

    // Expand first brief by default
    const firstExpandBtn = document.querySelector('.btn-expand');
    if (firstExpandBtn) {
        toggleBrief(firstExpandBtn);
    }
});
</script>
{% endblock %}
